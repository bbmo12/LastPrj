<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.last.prj.pmember.service.PmemberMapper">

	<resultMap type="com.last.prj.pmember.service.PmemberVO"
		id="pmembervo">
		<result column="p_id" property="p_id" />
		<result column="name" property="name" />
		<result column="tel" property="tel" />
		<result column="password" property="password" />
		<result column="n_content" property="n_content" />
		<result column="w_name" property="w_name" />
		<result column="w_address" property="w_address" />
		<result column="w_tel" property="w_tel" />
		<result column="p_info" property="p_info" />
		<result column="w_d_address" property="w_d_address"/>
		<result column="career" property="career"/>
        <result column="code" property="code" />
		<result column="p_license" property="p_license"/>
		<result column="p_image" property="p_image" />
		<result column="picture" property="picture" />
		<collection property="timeList" resultMap="TimeVO" />
	</resultMap>

	<resultMap type="com.last.prj.pmember.service.TimeVO"
		id="TimeVO">
		<result column="w_day" property="w_day" />
		<result column="starttime" property="starttime" />
		<result column="endtime" property="endtime" />
		<result column="n_content" property="n_content" />
	</resultMap>
	<!-- 상세페이지 -->
	<select id="getMember" parameterType="String"
		resultMap="pmembervo"
		resultType="com.last.prj.pmember.service.PmemberVO">
		SELECT *
		FROM P_MEMBER P, O_TIME T
		WHERE P.P_ID = T.P_ID AND P.P_ID = #{p_id}
	</select>
	
	<!-- 상담리뷰 -->
	<resultMap type="com.last.prj.pmember.service.ReviewVO" id="counselReview">
		<result column="content" property="content"/>
		<result column="rating" property="rating"/>
		<result column="m_id" property="m_id"/>
		<result column="picture" property="picture"/>
		<collection property="fileList" resultMap="FfileVO" />	
	</resultMap>
	<resultMap type="com.last.prj.pmember.service.FfileVO" id="FfileVO">
		<result column="photo" property="photo"/>	
	</resultMap>
	<select id="getCounselReview" parameterType="String" resultMap="counselReview"
	resultType="com.last.prj.pmember.service.ReviewVO">
		SELECT RE.CONTENT, 
		       RE.RATING, 
               M.M_ID, 
               M.PICTURE,
               F.PICTURE AS PHOTO
        FROM REVIEW RE LEFT JOIN COUNSEL C  
                ON RE.C_NO = C.C_NO
               LEFT JOIN PET P
                ON C.PET_NO = P.PET_NO 
               LEFT JOIN MEMBER M
                ON P.M_ID = M.M_ID 
               LEFT JOIN F_FILE F
                ON F.F_PART = RE.F_PART 
               WHERE C.P_ID = #{p_id}
	</select>
	
	<resultMap type="com.last.prj.pmember.service.ReviewVO" id="servieceReview">
		<result column="content" property="content"/>
		<result column="rating" property="rating"/>
		<result column="m_id" property="m_id"/>
		<result column="picture" property="picture"/>
		<collection property="fileList" resultMap="ffileVO" />
	</resultMap>
	<resultMap type="com.last.prj.pmember.service.FfileVO" id="ffileVO">
		<result column="photo" property="photo"/>	
	</resultMap>		
	<!-- 서비스리뷰 -->
	<select id="getServiceReview" parameterType="String" resultMap="servieceReview" resultType="com.last.prj.pmember.service.ReviewVO">
        SELECT RE.CONTENT, 
			   RE.RATING, 
			   M.M_ID, 
			   M.PICTURE,
               F.PICTURE AS PHOTO
        FROM REVIEW RE LEFT JOIN RESERVATION R
			  ON RE.R_NO = R.R_NO
             LEFT JOIN PET P
              ON R.PET_NO = P.PET_NO
			 LEFT JOIN MEMBER  M
              ON P.M_ID = M.M_ID
			 LEFT JOIN F_FILE F
			  ON F.F_PART = RE.F_PART
             WHERE R.P_ID = #{p_id}
	</select>
	<!-- 페이징번호 , 검색 가능-->
	<select id="memberPageList" resultType="com.last.prj.pmember.service.PmemberVO">
		   SELECT *
      			FROM ( SELECT ROWNUM RN, A.*
     			FROM (SELECT P_ID, NAME, PICTURE, CODE
      				   FROM P_MEMBER
       				  WHERE CODE = #{code}
       				  <if test="w_address != null and w_address != ''">AND W_ADDRESS LIKE '%'||#{w_address}||'%'</if>		
       				  ) A)
      	WHERE RN BETWEEN (#{pageNum}-1)*#{amount}+1
		AND (#{pageNum})*#{amount}
	</select>
	<!--총 회원  -->
	<select id="memberPage" resultType="int">		
      SELECT COUNT(*) AS total 
      FROM P_MEMBER
      WHERE CODE = #{code}
 	  <if test="w_address != null and w_address != ''">AND W_ADDRESS LIKE '%'||#{w_address}||'%'</if>		
	</select>
	
	<!-- 파트너정보수정 -->
	<update id="pmemberUpdate" parameterType="com.last.prj.pmember.service.PmemberVO">
		UPDATE P_MEMBER
			<set>
				<if test="name != null">name = #{name}, </if>
				<if test="password != null">password = #{password}, </if>
				<if test="tel != null">tel = #{tel}, </if>
				<if test="w_name != null">w_name = #{w_name},</if>
	  			<if test="w_address != null"> w_address = #{w_address}, </if>
	  			<if test="w_d_address != null"> w_d_address = #{w_d_address}, </if>				
	 		 	<if test="w_tel != null"> w_tel = #{w_tel}, </if>
	 		 	<if test="n_content != null"> n_content = #{n_content},</if>
	 			<if test="p_info != null"> p_info = #{p_info}, </if>
	  			<if test="career != null"> career = #{career}, </if> 
	  			<if test="speciality != null"> speciality = #{speciality} </if>
				<if test="picture != null">picture = #{picture}, </if>
				<if test="pfile != null">pfile = #{pfile}, </if>		
			</set>
		WHERE P_ID = #{p_id}
	</update>

	<!-- 관리자 -->
	<select id = "admPlistCode" parameterType="int" resultType="com.last.prj.pmember.service.PmemberVO">
		select p.p_id, p.name,p.c_report, p.startdate, f.content as f_content, p.tel as tel
		from p_member p, f_code f 
		where f.code = p.code AND p.code = #{code}
	</select>
	
	<select id="admPlist" resultType="com.last.prj.pmember.service.PmemberVO">
		SELECT P.P_ID, P.TEL,P.STARTDATE, P.C_REPORT, P.NAME, F.CONTENT as f_content
		FROM P_MEMBER P , F_CODE F 
		WHERE F.CODE=P.CODE
	</select>	

	
	<!-- 아이디로 정보 조회 -->
	<select id="PmemberOne" parameterType="String" resultType="com.last.prj.pmember.service.PmemberVO">
		SELECT *
		FROM p_member
		WHERE p_id = #{p_id}
	</select>

</mapper>